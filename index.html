<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retro Bullet Hell Shooter</title>
  <!-- „É¨„Éà„É≠Web„Éï„Ç©„É≥„Éà -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: 'Press Start 2P', cursive;
      text-align: center;
      user-select: none;
    }
    canvas {
      background: #000;
      display: block;
      margin: 20px auto;
      border: 3px solid #fff;
    }
    #ui {
      margin: 10px;
      font-size: 16px;
    }
    /* „Çπ„Çø„Éº„ÉàÁîªÈù¢ÔºÜ„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ */
    #startScreen, #gameOverScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      color: cyan;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    /* „Çπ„Çø„Éº„ÉàÁîªÈù¢„ÅÆÁîªÂÉè */
    #startScreen img {
      max-width: 80%;
      margin-bottom: 20px;
    }
    /* „Çπ„Çø„Éº„Éà„Éú„Çø„É≥ÔºöÁÇπÊªÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºÜ„ÇØ„É™„ÉÉ„ÇØÊúâÂäπÂåñ */
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    #startBtn {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
      background: yellow;
      color: black;
      border: none;
      font-family: 'Press Start 2P', cursive;
      animation: blink 1s infinite;
      pointer-events: auto;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
      background: yellow;
      color: black;
      border: none;
      font-family: 'Press Start 2P', cursive;
    }
  </style>
</head>
<body>
  <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
  <div id="startScreen">
    <!-- „Çπ„Çø„Éº„ÉàÁîªÂÉèËøΩÂä† -->
    <img src="startimage.png" alt="Retro Start Image">
    <h1>Retro Bullet Hell Shooter</h1>
    <p>
      For the peace of the universe,<br>
      the brave teddy bear (üß∏) battles evil pumpkins (üéÉ)!<br>
      Survive the barrage and deliver a critical blow to save the cosmos.
    </p>
    <button id="startBtn">Start Game</button>
    <p style="margin-top: 20px; font-size: 14px;">Created by o3</p>
  </div>
  
  <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº / ÂãùÂà©ÁîªÈù¢ -->
  <div id="gameOverScreen" style="display:none;">
    <h1 id="endTitle"></h1>
    <p id="endStory"></p>
    <p id="finalScore"></p>
    <button id="restartBtn">Restart</button>
  </div>
  
  <!-- „Ç≤„Éº„É†„Ç≠„É£„É≥„Éê„Çπ -->
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <!-- BGMÔºàSUNO„Åß‰ΩúÊàê„Åó„Åü bgm.mp3 „Çí‰ΩøÁî®Ôºâ -->
  <audio id="bgm" loop>
    <source src="./bgm.mp3" type="audio/mp3">
    Your browser does not support the audio element.
  </audio>
  
  <script>
    // „Ç≠„É£„É≥„Éê„ÇπÈñ¢ÈÄ£
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const cw = canvas.width, ch = canvas.height;
    
    // „Ç≤„Éº„É†Áä∂ÊÖã
    let gameRunning = false;
    let score = 0;
    
    // „Éó„É¨„Ç§„É§„ÉºË®≠ÂÆöÔºàüß∏Ôºâ‚ÄªÊÆãÂü∫„Çí10‚Üí3„Å´Â§âÊõ¥
    const player = {
      x: cw / 2 - 16,
      y: ch - 60,
      sprite: "üß∏",
      width: 32,
      height: 32,
      speed: 6,
      lives: 3
    };
    
    // ÊïµË®≠ÂÆöÔºàüéÉÔºâ
    const enemy = {
      x: cw / 2 - 16,
      y: 100,
      sprite: "üéÉ",
      width: 32,
      height: 32,
      speed: 2,
      direction: 1, // 1:Âè≥, -1:Â∑¶
      shootInterval: 2000,
      lastShotTime: 0,
      hp: 5
    };
    
    // ÂÖ•ÂäõÁä∂ÊÖã
    const keys = { left: false, right: false };
    document.addEventListener("keydown", (e) => {
      if(e.key === "ArrowLeft") keys.left = true;
      if(e.key === "ArrowRight") keys.right = true;
    });
    document.addEventListener("keyup", (e) => {
      if(e.key === "ArrowLeft") keys.left = false;
      if(e.key === "ArrowRight") keys.right = false;
    });
    
    // ÂºæÔºàBulletÔºâ„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Éó„Éº„É´
    const bulletPool = [];
    const POOL_SIZE = 100;
    for(let i = 0; i < POOL_SIZE; i++){
      bulletPool.push({
        x: 0, y: 0, dx: 0, dy: 0,
        type: "", // "player" or "enemy"
        sprite: "",
        active: false,
        radius: 10
      });
    }
    function getBullet() {
      for(let b of bulletPool){
        if(!b.active) {
          b.active = true;
          return b;
        }
      }
      return null;
    }
    
    // Êïµ„ÅåÁô∫Â∞Ñ„Åô„ÇãÂºæ„Éë„Çø„Éº„É≥Ôºà‰æãÔºöÂÜÜÂΩ¢„Éë„Çø„Éº„É≥Ôºâ
    function enemyShootPattern() {
      const numBullets = 12;
      const speed = 3;
      for(let i = 0; i < numBullets; i++){
        const angle = (i / numBullets) * 2 * Math.PI;
        const bullet = getBullet();
        if(bullet) {
          bullet.x = enemy.x + enemy.width/2;
          bullet.y = enemy.y + enemy.height/2;
          bullet.dx = Math.cos(angle) * speed;
          bullet.dy = Math.sin(angle) * speed;
          bullet.type = "enemy";
          // Âºæ„ÅÆÂü∫Êú¨„ÅØüíõ„ÄÅ„É©„É≥„ÉÄ„É†„Åß‰ªñËâ≤Ôºà‚ù§Ô∏è, üíôÔºâ
          bullet.sprite = (Math.random() < 0.7) ? "üíõ" : (Math.random() < 0.5 ? "‚ù§Ô∏è" : "üíô");
        }
      }
    }
    
    // „Éó„É¨„Ç§„É§„Éº„ÅÆÂºæ„ÇíÁô∫Â∞ÑÔºàÈÄöÂ∏∏„ÅØüç¨„ÄÅ10%„Åß„É¨„Ç¢„Å™üç≠Ôºâ
    function playerShoot() {
      const bullet = getBullet();
      if(bullet) {
        bullet.x = player.x + player.width/2;
        bullet.y = player.y;
        bullet.dx = 0;
        bullet.dy = -6;
        bullet.type = "player";
        bullet.sprite = (Math.random() < 0.1) ? "üç≠" : "üç¨";
      }
    }
    
    // „Éó„É¨„Ç§„É§„ÉºÂºæ„ÅÆÁô∫Â∞ÑÈñìÈöî
    let lastPlayerShot = 0;
    const playerShotInterval = 300;
    
    // ÁàÜÁô∫„Ç®„Éï„Çß„ÇØ„Éà
    const explosions = [];
    function spawnExplosion(x, y) {
      explosions.push({x, y, radius: 0, maxRadius: 20, life: 20});
    }
    
    // Á∞°Âçò„Å™ÂΩì„Åü„ÇäÂà§ÂÆöÔºàÂÜÜÂΩ¢Ôºâ
    function isColliding(a, b) {
      const dx = (a.x + a.width/2) - (b.x + b.width/2);
      const dy = (a.y + a.height/2) - (b.y + b.height/2);
      const distance = Math.sqrt(dx*dx + dy*dy);
      return distance < (a.width/2 + b.radius);
    }
    
    // Âºæ„ÅÆÊõ¥Êñ∞
    function updateBullets(delta) {
      for(let bullet of bulletPool){
        if(bullet.active){
          bullet.x += bullet.dx;
          bullet.y += bullet.dy;
          if(bullet.x < -20 || bullet.x > cw+20 || bullet.y < -20 || bullet.y > ch+20) {
            bullet.active = false;
          }
          // „Éó„É¨„Ç§„É§„Éº„ÅÆÂºæ„ÅåÊïµ„Å´ÂΩì„Åü„Å£„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if(bullet.type === "player" && enemy.hp > 0) {
            if(bullet.x > enemy.x && bullet.x < enemy.x+enemy.width &&
               bullet.y > enemy.y && bullet.y < enemy.y+enemy.height) {
              bullet.active = false;
              if(bullet.sprite === "üç≠") {  // „É¨„Ç¢Âºæ„Å™„ÇâÂç≥ÂãùÂà©
                enemy.hp = 0;
              } else {
                enemy.hp--;
              }
              spawnExplosion(enemy.x+enemy.width/2, enemy.y+enemy.height/2);
              score += 100;
              if(enemy.hp > 0) {
                enemy.x = cw/2 - enemy.width/2;
                enemy.y = 50;
                enemy.lastShotTime = performance.now();
              }
            }
          }
          // Êïµ„ÅÆÂºæ„Åå„Éó„É¨„Ç§„É§„Éº„Å´ÂΩì„Åü„Å£„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if(bullet.type === "enemy") {
            if(bullet.x > player.x && bullet.x < player.x+player.width &&
               bullet.y > player.y && bullet.y < player.y+player.height) {
              bullet.active = false;
              player.lives--;
              spawnExplosion(player.x+player.width/2, player.y+player.height/2);
            }
          }
        }
      }
    }
    
    // Âºæ„ÅÆÊèèÁîª
    function drawBullets() {
      for(let bullet of bulletPool){
        if(bullet.active){
          ctx.font = "24px 'Press Start 2P'";
          ctx.fillText(bullet.sprite, bullet.x, bullet.y);
        }
      }
    }
    
    // ÁàÜÁô∫„Ç®„Éï„Çß„ÇØ„ÉàÊõ¥Êñ∞ÔºÜÊèèÁîª
    function updateExplosions() {
      for(let i = explosions.length - 1; i >= 0; i--){
        const exp = explosions[i];
        exp.radius += 1;
        exp.life--;
        ctx.beginPath();
        ctx.arc(exp.x, exp.y, exp.radius, 0, 2*Math.PI);
        ctx.strokeStyle = "magenta";
        ctx.stroke();
        if(exp.life <= 0) {
          explosions.splice(i, 1);
        }
      }
    }
    
    // „Éó„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
    function updatePlayer() {
      if(keys.left && player.x > 0) {
        player.x -= player.speed;
      }
      if(keys.right && player.x + player.width < cw) {
        player.x += player.speed;
      }
    }
    
    // ÊïµÊõ¥Êñ∞ÔºàÊ®™ÁßªÂãïÔºãÂºæÁô∫Â∞ÑÔºâ
    function updateEnemy(timestamp) {
      enemy.x += enemy.speed * enemy.direction;
      if(enemy.x < 0 || enemy.x + enemy.width > cw) {
        enemy.direction *= -1;
      }
      if(timestamp - enemy.lastShotTime > enemy.shootInterval) {
        enemyShootPattern();
        enemy.lastShotTime = timestamp;
      }
    }
    
    // „Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£ÊèèÁîªÔºà„Éó„É¨„Ç§„É§„Éº„ÄÅÊïµ„ÄÅ„Çπ„Ç≥„Ç¢„ÉªÊÆãÊ©üË°®Á§∫Ôºâ
    function drawEntities() {
      if(player.lives > 0) {
        ctx.font = "32px 'Press Start 2P'";
        ctx.fillText(player.sprite, player.x, player.y + player.height);
      }
      if(enemy.hp > 0) {
        ctx.font = "32px 'Press Start 2P'";
        ctx.fillText(enemy.sprite, enemy.x, enemy.y + enemy.height);
      }
      ctx.font = "20px 'Press Start 2P'";
      ctx.fillStyle = "yellow";
      ctx.fillText("Score: " + score, 20, 40);
      ctx.fillText("Lives: " + player.lives, 20, 70);
      ctx.fillText("Enemy HP: " + enemy.hp, cw - 200, 40);
    }
    
    // „É°„Ç§„É≥„É´„Éº„Éó
    let lastTime = performance.now();
    function gameLoop(timestamp) {
      if(!gameRunning) return;
      const delta = timestamp - lastTime;
      lastTime = timestamp;
      
      ctx.clearRect(0, 0, cw, ch);
      updatePlayer();
      updateEnemy(timestamp);
      if(timestamp - lastPlayerShot > playerShotInterval) {
        playerShoot();
        lastPlayerShot = timestamp;
      }
      updateBullets(delta);
      updateExplosions();
      
      drawBullets();
      drawEntities();
      
      if(enemy.hp <= 0) {
        gameRunning = false;
        endGame(true);
        return;
      }
      if(player.lives <= 0) {
        gameRunning = false;
        endGame(false);
        return;
      }
      
      requestAnimationFrame(gameLoop);
    }
    
    // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂá¶ÁêÜ
    function endGame(win) {
      const screen = document.getElementById("gameOverScreen");
      const endTitle = document.getElementById("endTitle");
      const endStory = document.getElementById("endStory");
      const finalScore = document.getElementById("finalScore");
      
      if(win) {
        endTitle.innerText = "WIN!";
        endStory.innerText = "The brave teddy bear has defeated the evil pumpkins and restored cosmic peace!";
      } else {
        endTitle.innerText = "GAME OVER";
        endStory.innerText = "Alas, the bear has fallen... The universe remains in peril.";
      }
      finalScore.innerText = "Final Score: " + score;
      screen.style.display = "flex";
    }
    
    // „Çπ„Çø„Éº„Éà„ÉªÂÜç„Çπ„Çø„Éº„ÉàÂá¶ÁêÜ
    document.getElementById("startBtn").addEventListener("click", () => {
      document.getElementById("startScreen").style.display = "none";
      startGame();
    });
    document.getElementById("restartBtn").addEventListener("click", () => {
      document.getElementById("gameOverScreen").style.display = "none";
      resetGame();
      startGame();
    });
    
    // BGMÂÜçÁîü„Å®„Ç≤„Éº„É†ÈñãÂßã
    const bgm = document.getElementById("bgm");
    function startGame() {
      console.log("Game starting...");
      score = 0;
      player.x = cw / 2 - 16;
      player.lives = 3;  // ‚Üê „Éó„É¨„Ç§„É§„ÉºÊÆãÂü∫„Çí3„Å´Â§âÊõ¥
      enemy.x = cw / 2 - 16;
      enemy.y = 100;
      enemy.hp = 5;
      enemy.lastShotTime = performance.now();
      bulletPool.forEach(b => b.active = false);
      explosions.length = 0;
      gameRunning = true;
      lastTime = performance.now();
      bgm.volume = 0.3;
      bgm.play().catch(err => console.log("BGM play error", err));
      requestAnimationFrame(gameLoop);
    }
    
    function resetGame() {
      score = 0;
      player.lives = 3;
      enemy.hp = 5;
    }
    
  </script>
</body>
</html>
